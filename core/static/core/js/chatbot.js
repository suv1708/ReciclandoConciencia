// 🧠 Base de conocimiento — reciclaje y medio ambiente
const baseConocimiento = {
    "clasificación de residuos": {
        "¿Qué es el reciclaje?": "El reciclaje es el proceso de transformar materiales usados en nuevos productos, evitando el desperdicio y reduciendo la contaminación.",
        "¿Cuáles son los tipos de residuos?": "Los residuos se clasifican en orgánicos, reciclables e inservibles. Orgánicos: restos de comida; reciclables: plástico, vidrio, papel y metal; inservibles: los que no se pueden aprovechar.",
        "¿Qué color tiene cada contenedor de basura?": "Verde para vidrio, azul para papel y cartón, amarillo para plásticos y metales, gris o negro para basura no reciclable y marrón para orgánicos.",
        "¿Por qué es importante separar los residuos?": "Porque facilita el reciclaje, reduce la contaminación y permite aprovechar materiales que se pueden volver a usar.",
        "¿Qué materiales se pueden reciclar?": "Papel, cartón, vidrio, plástico, metales, pilas recargables y algunos textiles.",
        "¿Qué residuos no se deben mezclar?": "Los residuos orgánicos no deben mezclarse con vidrio, plástico o papel para evitar su contaminación.",
        "¿Qué significa el símbolo del reciclaje?": "Es un triángulo de flechas que representa el ciclo de reducir, reutilizar y reciclar."
    },
    "contaminación": {
        "¿Qué es la contaminación ambiental?": "Es la presencia de sustancias dañinas en el entorno que afectan la salud de los seres vivos y los ecosistemas.",
        "¿Cuáles son los tipos de contaminación?": "Del aire, del agua, del suelo, lumínica, acústica y visual.",
        "¿Qué causa la contaminación del agua?": "El vertimiento de basura, desechos químicos, petróleo y plásticos a ríos, mares y lagos.",
        "¿Cómo afecta la contaminación a los animales?": "Provoca pérdida de hábitats, intoxicaciones y muerte de especies.",
        "¿Qué podemos hacer para reducir la contaminación?": "Usar menos plástico, reciclar, evitar quemar basura y cuidar el agua.",
        "¿Qué es la contaminación del suelo?": "Es cuando se arrojan desechos o sustancias tóxicas al suelo, dañando su fertilidad.",
        "¿Cómo contribuye el plástico a la contaminación?": "Tarda siglos en degradarse y libera microplásticos al ambiente."
    },
    "reutilización": {
        "¿Qué significa reutilizar?": "Reutilizar es volver a usar un objeto o material sin desecharlo, dándole un nuevo propósito.",
        "¿Cuál es la diferencia entre reciclar y reutilizar?": "Reciclar transforma los materiales, mientras que reutilizar les da un nuevo uso sin modificarlos.",
        "¿Qué objetos se pueden reutilizar?": "Botellas, frascos, bolsas, cajas, ropa vieja, latas y cartones.",
        "¿Por qué es importante reutilizar?": "Reduce el consumo de recursos naturales y la cantidad de basura que generamos.",
        "¿Cómo puedo reutilizar en casa?": "Haz macetas con botellas, bolsas de tela, o usa frascos como organizadores.",
        "¿Qué beneficios tiene reutilizar?": "Ahorra dinero, protege el ambiente y fomenta la creatividad.",
        "¿Qué es el upcycling?": "Es reutilizar materiales para crear productos de mayor valor o utilidad que el original."
    },
    "impacto ambiental": {
        "¿Qué es el impacto ambiental?": "Es la huella o alteración que dejan las actividades humanas sobre la naturaleza.",
        "¿Qué causa el cambio climático?": "El aumento de gases de efecto invernadero por actividades humanas como la quema de combustibles fósiles.",
        "¿Cómo afecta la deforestación al planeta?": "Reduce el oxígeno, destruye hábitats y acelera el calentamiento global.",
        "¿Qué es la huella ecológica?": "Es la medida del impacto que genera una persona o comunidad por su consumo de recursos.",
        "¿Qué consecuencias tiene el mal manejo de la basura?": "Contaminación del suelo, proliferación de plagas y problemas de salud pública.",
        "¿Qué son los gases de efecto invernadero?": "Son gases que atrapan el calor del sol en la atmósfera, como el CO₂ y el metano.",
        "¿Qué es el calentamiento global?": "Es el aumento de la temperatura promedio del planeta por la actividad humana."
    },
    "consejos ecológicos": {
        "¿Cómo puedo cuidar el planeta?": "Reduce, reutiliza y recicla. Ahorra agua, usa menos plástico y prefiere productos ecológicos.",
        "¿Qué puedo hacer en casa para ser más ecológico?": "Apaga luces, separa la basura, reutiliza materiales y usa menos agua.",
        "¿Por qué debo evitar los plásticos de un solo uso?": "Porque contaminan durante siglos y dañan los ecosistemas marinos.",
        "¿Cómo puedo ahorrar energía?": "Usa bombillos LED, desconecta los aparatos que no uses y aprovecha la luz natural.",
        "¿Qué hábitos sostenibles puedo adoptar?": "Llevar tu propia bolsa, usar transporte público, reciclar y sembrar árboles.",
        "¿Cómo puedo cuidar el agua?": "Cierra el grifo mientras te cepillas los dientes y reutiliza el agua cuando sea posible.",
        "¿Qué puedo hacer en el colegio para cuidar el ambiente?": "Participa en campañas de reciclaje, cuida las plantas y evita botar basura al suelo."
    },
    "datos curiosos": {
        "¿Cuánto tarda en degradarse el plástico?": "Un plástico puede tardar entre 100 y 1000 años en degradarse completamente.",
        "¿Qué país recicla más en el mundo?": "Alemania, recicla más del 60% de sus residuos.",
        "¿Cuánto papel se puede ahorrar al reciclar?": "Reciclar una tonelada de papel salva 17 árboles y 26.000 litros de agua.",
        "¿Qué sucede si no reciclamos?": "Aumentan los vertederos, la contaminación y el deterioro ambiental.",
        "¿Cuál es el material más reciclado del mundo?": "El acero y el aluminio, porque se pueden reciclar infinitas veces sin perder calidad.",
        "¿Cuánta basura genera una persona al día?": "En promedio, cada persona genera entre 0.5 y 1 kilo de residuos diarios.",
        "¿Qué cantidad de vidrio se recicla?": "El vidrio se puede reciclar al 100% sin perder sus propiedades."
    }
};

// 🤝 Respuestas rápidas
const respuestasSaludo = [
    "¡Hola! 🌎 Soy tu asistente ecológico. ¿Quieres aprender sobre reciclaje?",
    "¡Hola! ♻️ Puedo enseñarte sobre cómo cuidar el planeta.",
    "¡Hey! 🌿 ¿Listo para aprender sobre medio ambiente?",
    "¡Buenos días! ☀️ Pregúntame sobre reciclaje o cómo reducir la contaminación.",
    "¡Buenas tardes! 🌻 Estoy aquí para ayudarte a cuidar el planeta.",
    "¡Hola! 👋 Soy EcoBot, tu guía sobre reciclaje y sostenibilidad.",
    "¡Qué gusto verte! 🌱 Pregúntame lo que quieras sobre el medio ambiente."
];

const respuestasDespedida = [
    "🌱 ¡Hasta pronto! Recuerda siempre reducir, reutilizar y reciclar.",
    "🌎 ¡Nos vemos! Cada pequeño cambio cuenta para salvar el planeta.",
    "♻️ ¡Adiós! Cuida la Tierra, es nuestro único hogar.",
    "👋 ¡Hasta la próxima! No olvides separar tus residuos.",
    "🌿 ¡Bye! Gracias por aprender sobre el cuidado ambiental.",
    "🍃 ¡Hasta luego! Sigue poniendo tu granito de arena por el planeta."
];

const respuestasNoEncontradas = [
    "🤔 No estoy seguro, ¿puedes reformular la pregunta?",
    "♻️ Intenta preguntarme sobre reciclaje, contaminación o consejos ecológicos.",
    "❓ Hmm, no tengo esa información aún, pero puedo ayudarte con temas ecológicos."
];

// 🧹 Funciones de procesamiento (Simplificadas para JS)
function limpiarTexto(texto) {
    texto = texto.toLowerCase();
    // Elimina caracteres que no son palabras, espacios, '¿', '?' o vocales/ñ acentuadas
    texto = texto.replace(/[^\w\s¿?áéíóúüñ]/g, ' ');
    return texto.trim().split(/\s+/).join(' '); // Normaliza espacios
}

function tokenizarTexto(texto) {
    return limpiarTexto(texto).split(' ');
}

// 🎯 Funciones del chatbot
function detectarSaludo(pregunta) {
    const saludos = ['hola', 'buenos días', 'buenas tardes', 'buenas noches', 'saludos', 'qué tal', 'hey', 'hola bot', 'holi', 'qué más'];
    const textoLimpio = limpiarTexto(pregunta);
    return saludos.some(saludo => textoLimpio.includes(saludo));
}

function detectarDespedida(pregunta) {
    const despedidas = ['adiós', 'hasta luego', 'nos vemos', 'chau', 'bye', 'salir', 'terminar', 'gracias', 'me voy'];
    const textoLimpio = limpiarTexto(pregunta);
    return despedidas.some(despedida => textoLimpio.includes(despedida));
}

/**
 * Calcula una similitud simple de Jaccard basada en la intersección de tokens.
 * Se usa como un reemplazo ligero para el coseno de similitud.
 */
function calcularSimilitudJaccard(tokensUsuario, tokensBase) {
    const setUsuario = new Set(tokensUsuario);
    const setBase = new Set(tokensBase);
    let interseccion = 0;

    for (const token of setUsuario) {
        if (setBase.has(token)) {
            interseccion++;
        }
    }
    
    const union = setUsuario.size + setBase.size - interseccion;
    return union === 0 ? 0 : interseccion / union;
}


function encontrarMejorRespuesta(preguntaUsuario) {
    if (detectarSaludo(preguntaUsuario)) {
        return randomChoice(respuestasSaludo);
    }
    if (detectarDespedida(preguntaUsuario)) {
        return randomChoice(respuestasDespedida);
    }

    let mejorRespuesta = "";
    let mejorPuntuacion = 0;
    let temaEncontrado = "";
    const tokensUsuario = tokenizarTexto(preguntaUsuario);

    for (const tema in baseConocimiento) {
        const preguntas = baseConocimiento[tema];
        for (const preguntaBase in preguntas) {
            const tokensBase = tokenizarTexto(preguntaBase);
            const puntuacion = calcularSimilitudJaccard(tokensUsuario, tokensBase);
            
            if (puntuacion > mejorPuntuacion) {
                mejorPuntuacion = puntuacion;
                mejorRespuesta = preguntas[preguntaBase];
                temaEncontrado = tema;
            }
        }
    }

    const umbral = 0.2; // Umbral de similitud más bajo que en Python por la simpleza del cálculo
    if (mejorPuntuacion > umbral) {
        // Capitaliza la primera letra de cada palabra del tema para un mejor formato
        const temaCapitalizado = temaEncontrado.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        return `🌿 [${temaCapitalizado}] ${mejorRespuesta}`;
    } else {
        return randomChoice(respuestasNoEncontradas);
    }
}

function randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

// 🌐 Manipulación del DOM y Lógica de Interfaz
const chatToggleBtn = document.getElementById('chat-toggle-btn');
const chatbotContainer = document.getElementById('chatbot-container');
const closeChatBtn = document.getElementById('close-chat-btn');
const chatMessages = document.getElementById('chat-messages');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

// Evento para abrir/cerrar el chatbot
chatToggleBtn.addEventListener('click', () => {
    chatbotContainer.classList.toggle('hidden');
    if (!chatbotContainer.classList.contains('hidden')) {
        userInput.focus(); // Enfoca el input al abrir
        scrollToBottom(); // Asegura que se vea el último mensaje
    }
});

// Evento para cerrar el chatbot
closeChatBtn.addEventListener('click', () => {
    chatbotContainer.classList.add('hidden');
});

// Evento para enviar mensaje al hacer click
sendBtn.addEventListener('click', () => {
    procesarEntradaUsuario();
});

// Evento para enviar mensaje al presionar Enter
userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        procesarEntradaUsuario();
    }
});

function agregarMensaje(texto, tipo) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', `${tipo}-message`);
    messageDiv.textContent = texto;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function procesarEntradaUsuario() {
    const pregunta = userInput.value.trim();
    if (pregunta === "") return;

    // 1. Mostrar mensaje del usuario
    agregarMensaje(pregunta, 'user');
    userInput.value = ''; // Limpiar input

    // 2. Obtener respuesta del bot
    const respuestaBot = encontrarMejorRespuesta(pregunta);

    // 3. Mostrar respuesta del bot
    // Se usa un pequeño retardo para simular el "pensamiento" del bot
    setTimeout(() => {
        agregarMensaje(respuestaBot, 'bot');
    }, 500);

    // Si la respuesta es de despedida, se cierra el chat después de un tiempo
    if (detectarDespedida(pregunta) && respuestasDespedida.includes(respuestaBot)) {
        setTimeout(() => {
            chatbotContainer.classList.add('hidden');
        }, 2000);
    }
}
