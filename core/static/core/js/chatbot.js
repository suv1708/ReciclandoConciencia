// ðŸ§  Base de conocimiento â€” reciclaje y medio ambiente
const baseConocimiento = {
    "clasificaciÃ³n de residuos": {
        "Â¿QuÃ© es el reciclaje?": "El reciclaje es el proceso de transformar materiales usados en nuevos productos, evitando el desperdicio y reduciendo la contaminaciÃ³n.",
        "Â¿CuÃ¡les son los tipos de residuos?": "Los residuos se clasifican en orgÃ¡nicos, reciclables e inservibles. OrgÃ¡nicos: restos de comida; reciclables: plÃ¡stico, vidrio, papel y metal; inservibles: los que no se pueden aprovechar.",
        "Â¿QuÃ© color tiene cada contenedor de basura?": "Verde para vidrio, azul para papel y cartÃ³n, amarillo para plÃ¡sticos y metales, gris o negro para basura no reciclable y marrÃ³n para orgÃ¡nicos.",
        "Â¿Por quÃ© es importante separar los residuos?": "Porque facilita el reciclaje, reduce la contaminaciÃ³n y permite aprovechar materiales que se pueden volver a usar.",
        "Â¿QuÃ© materiales se pueden reciclar?": "Papel, cartÃ³n, vidrio, plÃ¡stico, metales, pilas recargables y algunos textiles.",
        "Â¿QuÃ© residuos no se deben mezclar?": "Los residuos orgÃ¡nicos no deben mezclarse con vidrio, plÃ¡stico o papel para evitar su contaminaciÃ³n.",
        "Â¿QuÃ© significa el sÃ­mbolo del reciclaje?": "Es un triÃ¡ngulo de flechas que representa el ciclo de reducir, reutilizar y reciclar."
    },
    "contaminaciÃ³n": {
        "Â¿QuÃ© es la contaminaciÃ³n ambiental?": "Es la presencia de sustancias daÃ±inas en el entorno que afectan la salud de los seres vivos y los ecosistemas.",
        "Â¿CuÃ¡les son los tipos de contaminaciÃ³n?": "Del aire, del agua, del suelo, lumÃ­nica, acÃºstica y visual.",
        "Â¿QuÃ© causa la contaminaciÃ³n del agua?": "El vertimiento de basura, desechos quÃ­micos, petrÃ³leo y plÃ¡sticos a rÃ­os, mares y lagos.",
        "Â¿CÃ³mo afecta la contaminaciÃ³n a los animales?": "Provoca pÃ©rdida de hÃ¡bitats, intoxicaciones y muerte de especies.",
        "Â¿QuÃ© podemos hacer para reducir la contaminaciÃ³n?": "Usar menos plÃ¡stico, reciclar, evitar quemar basura y cuidar el agua.",
        "Â¿QuÃ© es la contaminaciÃ³n del suelo?": "Es cuando se arrojan desechos o sustancias tÃ³xicas al suelo, daÃ±ando su fertilidad.",
        "Â¿CÃ³mo contribuye el plÃ¡stico a la contaminaciÃ³n?": "Tarda siglos en degradarse y libera microplÃ¡sticos al ambiente."
    },
    "reutilizaciÃ³n": {
        "Â¿QuÃ© significa reutilizar?": "Reutilizar es volver a usar un objeto o material sin desecharlo, dÃ¡ndole un nuevo propÃ³sito.",
        "Â¿CuÃ¡l es la diferencia entre reciclar y reutilizar?": "Reciclar transforma los materiales, mientras que reutilizar les da un nuevo uso sin modificarlos.",
        "Â¿QuÃ© objetos se pueden reutilizar?": "Botellas, frascos, bolsas, cajas, ropa vieja, latas y cartones.",
        "Â¿Por quÃ© es importante reutilizar?": "Reduce el consumo de recursos naturales y la cantidad de basura que generamos.",
        "Â¿CÃ³mo puedo reutilizar en casa?": "Haz macetas con botellas, bolsas de tela, o usa frascos como organizadores.",
        "Â¿QuÃ© beneficios tiene reutilizar?": "Ahorra dinero, protege el ambiente y fomenta la creatividad.",
        "Â¿QuÃ© es el upcycling?": "Es reutilizar materiales para crear productos de mayor valor o utilidad que el original."
    },
    "impacto ambiental": {
        "Â¿QuÃ© es el impacto ambiental?": "Es la huella o alteraciÃ³n que dejan las actividades humanas sobre la naturaleza.",
        "Â¿QuÃ© causa el cambio climÃ¡tico?": "El aumento de gases de efecto invernadero por actividades humanas como la quema de combustibles fÃ³siles.",
        "Â¿CÃ³mo afecta la deforestaciÃ³n al planeta?": "Reduce el oxÃ­geno, destruye hÃ¡bitats y acelera el calentamiento global.",
        "Â¿QuÃ© es la huella ecolÃ³gica?": "Es la medida del impacto que genera una persona o comunidad por su consumo de recursos.",
        "Â¿QuÃ© consecuencias tiene el mal manejo de la basura?": "ContaminaciÃ³n del suelo, proliferaciÃ³n de plagas y problemas de salud pÃºblica.",
        "Â¿QuÃ© son los gases de efecto invernadero?": "Son gases que atrapan el calor del sol en la atmÃ³sfera, como el COâ‚‚ y el metano.",
        "Â¿QuÃ© es el calentamiento global?": "Es el aumento de la temperatura promedio del planeta por la actividad humana."
    },
    "consejos ecolÃ³gicos": {
        "Â¿CÃ³mo puedo cuidar el planeta?": "Reduce, reutiliza y recicla. Ahorra agua, usa menos plÃ¡stico y prefiere productos ecolÃ³gicos.",
        "Â¿QuÃ© puedo hacer en casa para ser mÃ¡s ecolÃ³gico?": "Apaga luces, separa la basura, reutiliza materiales y usa menos agua.",
        "Â¿Por quÃ© debo evitar los plÃ¡sticos de un solo uso?": "Porque contaminan durante siglos y daÃ±an los ecosistemas marinos.",
        "Â¿CÃ³mo puedo ahorrar energÃ­a?": "Usa bombillos LED, desconecta los aparatos que no uses y aprovecha la luz natural.",
        "Â¿QuÃ© hÃ¡bitos sostenibles puedo adoptar?": "Llevar tu propia bolsa, usar transporte pÃºblico, reciclar y sembrar Ã¡rboles.",
        "Â¿CÃ³mo puedo cuidar el agua?": "Cierra el grifo mientras te cepillas los dientes y reutiliza el agua cuando sea posible.",
        "Â¿QuÃ© puedo hacer en el colegio para cuidar el ambiente?": "Participa en campaÃ±as de reciclaje, cuida las plantas y evita botar basura al suelo."
    },
    "datos curiosos": {
        "Â¿CuÃ¡nto tarda en degradarse el plÃ¡stico?": "Un plÃ¡stico puede tardar entre 100 y 1000 aÃ±os en degradarse completamente.",
        "Â¿QuÃ© paÃ­s recicla mÃ¡s en el mundo?": "Alemania, recicla mÃ¡s del 60% de sus residuos.",
        "Â¿CuÃ¡nto papel se puede ahorrar al reciclar?": "Reciclar una tonelada de papel salva 17 Ã¡rboles y 26.000 litros de agua.",
        "Â¿QuÃ© sucede si no reciclamos?": "Aumentan los vertederos, la contaminaciÃ³n y el deterioro ambiental.",
        "Â¿CuÃ¡l es el material mÃ¡s reciclado del mundo?": "El acero y el aluminio, porque se pueden reciclar infinitas veces sin perder calidad.",
        "Â¿CuÃ¡nta basura genera una persona al dÃ­a?": "En promedio, cada persona genera entre 0.5 y 1 kilo de residuos diarios.",
        "Â¿QuÃ© cantidad de vidrio se recicla?": "El vidrio se puede reciclar al 100% sin perder sus propiedades."
    }
};

// ðŸ¤ Respuestas rÃ¡pidas
const respuestasSaludo = [
    "Â¡Hola! ðŸŒŽ Soy tu asistente ecolÃ³gico. Â¿Quieres aprender sobre reciclaje?",
    "Â¡Hola! â™»ï¸ Puedo enseÃ±arte sobre cÃ³mo cuidar el planeta.",
    "Â¡Hey! ðŸŒ¿ Â¿Listo para aprender sobre medio ambiente?",
    "Â¡Buenos dÃ­as! â˜€ï¸ PregÃºntame sobre reciclaje o cÃ³mo reducir la contaminaciÃ³n.",
    "Â¡Buenas tardes! ðŸŒ» Estoy aquÃ­ para ayudarte a cuidar el planeta.",
    "Â¡Hola! ðŸ‘‹ Soy EcoBot, tu guÃ­a sobre reciclaje y sostenibilidad.",
    "Â¡QuÃ© gusto verte! ðŸŒ± PregÃºntame lo que quieras sobre el medio ambiente."
];

const respuestasDespedida = [
    "ðŸŒ± Â¡Hasta pronto! Recuerda siempre reducir, reutilizar y reciclar.",
    "ðŸŒŽ Â¡Nos vemos! Cada pequeÃ±o cambio cuenta para salvar el planeta.",
    "â™»ï¸ Â¡AdiÃ³s! Cuida la Tierra, es nuestro Ãºnico hogar.",
    "ðŸ‘‹ Â¡Hasta la prÃ³xima! No olvides separar tus residuos.",
    "ðŸŒ¿ Â¡Bye! Gracias por aprender sobre el cuidado ambiental.",
    "ðŸƒ Â¡Hasta luego! Sigue poniendo tu granito de arena por el planeta."
];

const respuestasNoEncontradas = [
    "ðŸ¤” No estoy seguro, Â¿puedes reformular la pregunta?",
    "â™»ï¸ Intenta preguntarme sobre reciclaje, contaminaciÃ³n o consejos ecolÃ³gicos.",
    "â“ Hmm, no tengo esa informaciÃ³n aÃºn, pero puedo ayudarte con temas ecolÃ³gicos."
];

// ðŸ§¹ Funciones de procesamiento (Simplificadas para JS)
function limpiarTexto(texto) {
    texto = texto.toLowerCase();
    // Elimina caracteres que no son palabras, espacios, 'Â¿', '?' o vocales/Ã± acentuadas
    texto = texto.replace(/[^\w\sÂ¿?Ã¡Ã©Ã­Ã³ÃºÃ¼Ã±]/g, ' ');
    return texto.trim().split(/\s+/).join(' '); // Normaliza espacios
}

function tokenizarTexto(texto) {
    return limpiarTexto(texto).split(' ');
}

// ðŸŽ¯ Funciones del chatbot
function detectarSaludo(pregunta) {
    const saludos = ['hola', 'buenos dÃ­as', 'buenas tardes', 'buenas noches', 'saludos', 'quÃ© tal', 'hey', 'hola bot', 'holi', 'quÃ© mÃ¡s'];
    const textoLimpio = limpiarTexto(pregunta);
    return saludos.some(saludo => textoLimpio.includes(saludo));
}

function detectarDespedida(pregunta) {
    const despedidas = ['adiÃ³s', 'hasta luego', 'nos vemos', 'chau', 'bye', 'salir', 'terminar', 'gracias', 'me voy'];
    const textoLimpio = limpiarTexto(pregunta);
    return despedidas.some(despedida => textoLimpio.includes(despedida));
}

/**
 * Calcula una similitud simple de Jaccard basada en la intersecciÃ³n de tokens.
 * Se usa como un reemplazo ligero para el coseno de similitud.
 */
function calcularSimilitudJaccard(tokensUsuario, tokensBase) {
    const setUsuario = new Set(tokensUsuario);
    const setBase = new Set(tokensBase);
    let interseccion = 0;

    for (const token of setUsuario) {
        if (setBase.has(token)) {
            interseccion++;
        }
    }
    
    const union = setUsuario.size + setBase.size - interseccion;
    return union === 0 ? 0 : interseccion / union;
}


function encontrarMejorRespuesta(preguntaUsuario) {
    if (detectarSaludo(preguntaUsuario)) {
        return randomChoice(respuestasSaludo);
    }
    if (detectarDespedida(preguntaUsuario)) {
        return randomChoice(respuestasDespedida);
    }

    let mejorRespuesta = "";
    let mejorPuntuacion = 0;
    let temaEncontrado = "";
    const tokensUsuario = tokenizarTexto(preguntaUsuario);

    for (const tema in baseConocimiento) {
        const preguntas = baseConocimiento[tema];
        for (const preguntaBase in preguntas) {
            const tokensBase = tokenizarTexto(preguntaBase);
            const puntuacion = calcularSimilitudJaccard(tokensUsuario, tokensBase);
            
            if (puntuacion > mejorPuntuacion) {
                mejorPuntuacion = puntuacion;
                mejorRespuesta = preguntas[preguntaBase];
                temaEncontrado = tema;
            }
        }
    }

    const umbral = 0.2; // Umbral de similitud mÃ¡s bajo que en Python por la simpleza del cÃ¡lculo
    if (mejorPuntuacion > umbral) {
        // Capitaliza la primera letra de cada palabra del tema para un mejor formato
        const temaCapitalizado = temaEncontrado.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        return `ðŸŒ¿ [${temaCapitalizado}] ${mejorRespuesta}`;
    } else {
        return randomChoice(respuestasNoEncontradas);
    }
}

function randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

// ðŸŒ ManipulaciÃ³n del DOM y LÃ³gica de Interfaz
const chatToggleBtn = document.getElementById('chat-toggle-btn');
const chatbotContainer = document.getElementById('chatbot-container');
const closeChatBtn = document.getElementById('close-chat-btn');
const chatMessages = document.getElementById('chat-messages');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

// Evento para abrir/cerrar el chatbot
chatToggleBtn.addEventListener('click', () => {
    chatbotContainer.classList.toggle('hidden');
    if (!chatbotContainer.classList.contains('hidden')) {
        userInput.focus(); // Enfoca el input al abrir
        scrollToBottom(); // Asegura que se vea el Ãºltimo mensaje
    }
});

// Evento para cerrar el chatbot
closeChatBtn.addEventListener('click', () => {
    chatbotContainer.classList.add('hidden');
});

// Evento para enviar mensaje al hacer click
sendBtn.addEventListener('click', () => {
    procesarEntradaUsuario();
});

// Evento para enviar mensaje al presionar Enter
userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        procesarEntradaUsuario();
    }
});

function agregarMensaje(texto, tipo) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', `${tipo}-message`);
    messageDiv.textContent = texto;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function procesarEntradaUsuario() {
    const pregunta = userInput.value.trim();
    if (pregunta === "") return;

    // 1. Mostrar mensaje del usuario
    agregarMensaje(pregunta, 'user');
    userInput.value = ''; // Limpiar input

    // 2. Obtener respuesta del bot
    const respuestaBot = encontrarMejorRespuesta(pregunta);

    // 3. Mostrar respuesta del bot
    // Se usa un pequeÃ±o retardo para simular el "pensamiento" del bot
    setTimeout(() => {
        agregarMensaje(respuestaBot, 'bot');
    }, 500);

    // Si la respuesta es de despedida, se cierra el chat despuÃ©s de un tiempo
    if (detectarDespedida(pregunta) && respuestasDespedida.includes(respuestaBot)) {
        setTimeout(() => {
            chatbotContainer.classList.add('hidden');
        }, 2000);
    }
}
